// zircon_dpbeta_changes.txt - October 14 2023

Note: Largely fixed issues with DarkPlaces Beta having stuck +forward forever on ALT-TAB and other situations.
      However, I have still experienced it once on changelevel.  Eventually I'll find out way.

      I saw Linux print segfault on shutdown.

      I think I saw evidence of trashed memory when performing a gamedir switch to Quake Combat+.

      cl_bobmodel_classic is the darkplaces toggle

      model clear not work.
      I'm not sure we save config before gamedir change

failed quakeworld connect ... I see "loading" and cannot get to menu?  Stuff seems okish.


quake15 - rtlight e1m2 is fuct, we can debug in e1m2 in id1 ... is it loading or what?
e1m2 water is fuct --- why is the scale wrong?  is it a shader? showtex -- dm3
*water1
{
	 surfaceparm water
	surfaceparm nomarks
	surfaceparm trans
	deformvertexes wave 10 sin 1 1 .1 .6
		blendfunc blend

		tcMod stretch sin 1 .001 .05 .2
		tcMod scale 0.05 0.05
		tcMod scroll 0.016 0.01
		animmap 18 textures/causticBr/FWATER01.png textures/causticBr/FWATER02.png textures/causticBr/FWATER03.png textures/causticBr/FWATER04.png textures/causticBr/FWATER05.png textures/causticBr/FWATER06.png textures/causticBr/FWATER07.png textures/causticBr/FWATER08.png textures/causticBr/FWATER09.png textures/causticBr/FWATER10.png textures/causticBr/FWATER11.png textures/causticBr/FWATER12.png textures/causticBr/FWATER13.png textures/causticBr/FWATER14.png textures/causticBr/FWATER15.png textures/causticBr/FWATER16.png textures/causticBr/FWATER17.png textures/causticBr/FWATER18.png textures/causticBr/FWATER19.png textures/causticBr/FWATER20.png textures/causticBr/FWATER21.png textures/causticBr/FWATER22.png textures/causticBr/FWATER23.png textures/causticBr/FWATER24.png textures/causticBr/FWATER25.png textures/causticBr/FWATER26.png textures/causticBr/FWATER27.png textures/causticBr/FWATER28.png textures/causticBr/FWATER29.png textures/causticBr/FWATER30.png textures/causticBr/FWATER31.png textures/causticBr/FWATER32.png textures/causticBr/FWATER33.png textures/causticBr/FWATER34.png textures/causticBr/FWATER35.png

texture name is what? 
we need our test maps, zircon!
Also what quake3_quake1 lightning!!!

DarkPlaces gives me "player exited the level twice"?
Is it being sent twice?  Or received twice?  Confirmed, DarkPlaces 2014 does this.

scr_infobar_height

// Baker: CHECKTHIS LOOKS WRONG <---cmd.c  (we did that and fixed now.)

Check the bones thing
Check colors like ^2


Lightning does not look like previous darkplaces, it's not white

console
menu
maps
lightning particle

// We aren't doing more silly folders for a single file, this can go in particles folders
// where other particles stuff goes.

Sky Zombies. And DarkPlaces Beta does not have this issue.

(SOLVED)   Commands simply disappear after gamedir switch.  Example vid_conwidth?
(NOTISSUE) dp beta 2 does not have vid_conwidth after gamedir switch
dp april does

qmb lightning is wrong for all zircons with quake3_quake1

We get sky zombies in both us and Zirocn64 sdl

Nehahra demos menu has never been tested?  Likely flawed.
----
 did we before our change?
  Yes.
  	drawsel_idx = gameoptions_cursor; // DUBIOUS!
	PPX_DrawSel_End ();


// BETA 7

Nearest 2D fix
nostartdemos


// BETA 6

1461. Eliminated message for missing beam.mdl, this is a virtually non-existent model no other engine precaches or warns about.
      And any mod that actually uses it should precache it in QuakeC.  It is for TE_BEAM, a grappling hook effect.
9061. DarkPlaces Beta gamedir switch crash had 2 more factors.  Resolved.
9062. Clear models/sounds was partially ineffective due to new DarkPlaces Beta different order of events, fixed.
1462. Progress bar maxfps to 10 from 20 mirroring DarkPlaces classic.  The less this is on-screen, the faster content loads.
0061. DarkPlaces 2014 physics.  Reverting to what I hope is traditional DarkPlaces 2014 engine physics which is what mods targeting DarkPlaces
      from 2014 to present expect for physics in DarkPlaces.  New DarkPlaces physics had immediate issue with Quake Combat+ on E1M1 (a soldier falls 
      through floor) and some Alkaline map printing droptofloor issues (one would naturally assume that
      in Quakespasm does not do this).  DarkPlaces 2014 physics do have issues with classic Quake occasionally, a great 
      example is E4M7 zombies above water after killing the zombies below water in the start of the map, but this does allow Zircon
      DarkPlaces Beta to correctly play mods made for DarkPlaces like Quake Combat+.
0062. Zircon modified cvar defaults for Quake: gl_texturemode gl_linear_mipmap_linear and sv_gameplayfix_droptofloorstartsolid 1. 
9063. Quake Combat+ map E1M2 bridge, DarkPlaces Beta shows blue light and DarkPlaces classic does not.  The .rtlights file
      has negative rgb values for some colors (3.540270 -0.000000 -2.528764).  Zircon DarkPlaces Beta clamps the RGB values on
      read to a minimum of 0.  However, this cures only the effects of a yet identified difference, the root cause has not
      yet been identified.
7062. textures/particles/lightning -> particles/lightning .. this is a change but all particle gfx live in particles folder 
      and it is silly to have 1 file related to particles living in a weird place as the only member of its folder.

// BETA 5

1431. Less console spam.

// BETA 4 Additions - October 19 2023

1241. Max saves games to 20 mirroring traditional single player engines.

// BETA 3 Additions - October 18 2023

1421. FitzQuake centerprint logging ("This hallway selects EASY skill" prints to console, some maps have important centerprint messages)

// BETA 2 Additions - October 17 2023

Added Linux build.

1211. 64-bit lightmap fix from Quakespasm
1411. "saveconfig" takes an argument so "saveconfig mine" is possible.
1412. animated texture warning is now a developer print, this occurs quake start.bsp
      Texture +0slipbot is animated (leading +) but has only one frame
1413. Disabled "Windows" keys.
1414. Automatic unload of "fte csqc-lite" csprogs.dat allowing convenient play of these mods (see alk1.2.zip @ Quaddicted)
      This is an alternate CSQC that FTE/Quakespasm Spiked supports.
8011. Removed progs/v_nail2.mdl from r_nolerp list to mirror Zircon
8012. Removed deathmatch mini-overlay
8013. r_nearest_2d and r_nearest_conchars default 1.
9011. DarkPlaces Beta was only loading the first q1bsp sky.  Successive map changes, a q1bsp sky was always ignored so as a result E1M1 would have a purple start map sky instead of a blue sky.
9012. More ALT-TAB key release hardening and made in_releaseall clear kbutton structs.
9511. Fixed vid_sdl.h so Windows get a titlebar icon consistently.  Sometimes it was there, sometimes not.

// CUMULATIVE ALL:

// Zircon Major Features

0000. Mouse driven menu
0001. ALT-ENTER support to switch from fullscreen to windowed mode.
0002. Key setup streamlined order, elimination of "???" for unbound keys.
0003. Thin console cursor, no cursor overwrite mode.
0004. Ctrl + Up, Ctrl + Down adjust size the console like JoeQuake.
0005. Crisp 2D autoscale based on 360 pixels of height (720 height is 2x magnification) with user customization possible.
0006. LodePNG used for PNG loading.
0061. DarkPlaces 2014 physics. Reverting to what I hope is traditional DarkPlaces 2014 engine physics which is what mods targeting DarkPlaces
      from 2014 to present expect for physics in DarkPlaces.  New DarkPlaces physics had immediate issue with Quake Combat+ on E1M1 (a soldier falls 
      through floor) and some Alkaline map printing droptofloor issues (one would naturally assume that
      in Quakespasm does not do this).  DarkPlaces 2014 physics do have issues with classic Quake occasionally, a great 
      example is E4M7 zombies above water after killing the zombies below water in the start of the map, but this does allow Zircon
      DarkPlaces Beta to correctly play mods made for DarkPlaces like Quake Combat+.
0062. Full auto-completion.
0081. Quake Remaster status bar option (sbar_quake 2).
0082. r_waterwarp 2 twisty underwater effect.
0083. r_waterdeform 1 WinQuake-like water/slime deformation.  r_waterdeform 2, lava too.
0084. BloodOmnicide DarkPlaces roundwave shader deformation support

// Single player compatibility with Quake

1001. Standard Quake file paths for loading/saving on Windows and Mac (-nohome, Linux we will do DarkPlaces way).
1002. Standard Quake behavior for Q1BSP maps with no light data -- all entities in map render fullbright.  DarkPlaces beta differs from Quake and old DarkPlaces (div0-stable)
1003. Standard Quake behavior for "map", "kill", etc. which close the console in Quake.  Full list: map, load <game>, restart, changelevel, connect, reconnect, kill.
1004. Standard Quake appearance of bronzed characters (not yellow).
1081. Standard Quake appearance of status bar as an option (status bar backtile option)
1082. Standard Quake appearance of status bar/scoreboard, displaying total secrets, total monsters even if zero 

// Single player compatibility with Quakespasm (FitzQuake 0.85) norms

1201. "r_skyfog"    fog that looks like FitzQuake/Quakespasm which is defaulting fog alpha to 0.5 (r_skyfog value) if fog is not specified in map fogkey
1202. "map"         command with no params says map name.  This is a behavior in Quakespasm and most modern Quake engines have this feature.
1203. "game"        console command, same behavior as gamedir.
1210. shot1sid shotgun shells texture fix, in most Quake engines since 2000 (look at shotgun shells on DM3 bridge)
1211. 64-bit lightmap fix from Quakespasm
1241. Max save games in save game menu to 20 mirroring other engines.

1301. Disconnect automatically when "game" / "gamedir" used if not disconnected.

// Single player convenience

1401. **** sv_cheats defaults 1.
1402. Reset menu cursors on gamedir change
1403. log_file_stripcolors defaults 1 for more readable console .log file.
1411. "saveconfig" takes an argument so "saveconfig mine" is possible.
1412. animated texture warning is now a developer print, this occurs quake start.bsp
      Texture +0slipbot is animated (leading +) but has only one frame
1413. Disabled Windows keys.
1414. Automatic unload of "fte csqc-lite" csprogs.dat allowing convenient play of these mods (see alk1.2.zip @ Quaddicted)
      This is an alternate CSQC that FTE/Quakespasm Spiked supports.
1421. FitzQuake centerprint logging ("This hallway selects EASY skill" prints to console, some maps have important centerprint messages)
1451. Less spam of clutter to console.
1461. Eliminated message for missing beam.mdl, this is a virtually non-existent model no other engine precaches or warns about.
      And any mod that actually uses it should precache it in QuakeC.  It is for TE_BEAM, a grappling hook effect.
1462. Progress bar maxfps to 10 from 20 mirroring DarkPlaces classic.  The less this is on-screen, the faster content loads.
1471. "maps" command only lists playable maps (info_player_start, info_player_deathmatch found).   This may not be compatible with
      Xonotic / Quake3 /  mods that do not use those entity types.  Additionally, a md3 content replacement healthbox with a .bsp
      extension is known to evade this filter and get printed (due to not falling into a BSP type).
1481. Reduced message "spam" for ALT-ENTER and other frequent situations
1482. ALT-ENTER with vid_desktopfullscreen (the default) uses 75% width/height for windowed mode automatically.
1483. **** vid_resizable defaults 1.

// New commands / cvars

3101. "copy" copies console to clipboard, "copy ents" copies map entities to clipboard.
3102. "folder" command -- opens gamedir folder in file explorer
3103. "pwd" command - prints current directory
3171. "pos" command - prints current position, copies it to clipboard.
3172. "nostartdemos" cvar - set to 1 and they do not start.
3173. "cvar_reset", "inc", "dec" commands

// Performance

5001. ****Laptop friendly default cl_maxfps 144 (not 0 unlimited).  Laptops have 90% of personal computer marketshare.
      Laptops have a battery and laptops have small cooling fans.  Rendering at 800 fps for no particular reason is
      is not nice to a laptop battery and it is not nice to a laptop cooling fan.

5002. **** cl_prydoncursor_notrace defaults 1 (off).  This does not need to run every frame.  I know of no mod aside from Prydon Gate that uses it.

// Developer

7001. freetype.dll that is friendly with Visual Studio 2022 and does not cause exception with ntdll.dll
7002. Baker.h - tons of functions (file system, string, matrix, etc.)
7003. csqc_full_width_height 1 will set vid_conwidth/vid_conheight to entire client area (like vid.width/vid.height) during csqc phase and then change it back
7004. cvar if (cvar(csqc_full_width_height_available)) is a way for csqc to check for this.  Todo: check extension instead?
7061. "modeldecompile" commmand (writes a model as .obj) converts * (asterisk) to _ (underscore) for sub-models so that they
      can be written to file on Windows which will not allow asterisks in a filename.
7062. textures/particles/lightning -> particles/lightning .. this is a change but all particle gfx live in particles folder 
      and it is silly to have 1 file related to particles living in a weird place as the only member of its folder.
7063. r_listmaptextures [optional partial to find] like "r_listmaptextures water"
7064.
7081. showtex 1 displays only texture information, showtex 2 displays texture information and entity
7082. showpos and showangles cvars.
7083. showfps -1 shows fps in top right corner of screen where most other engines display frames per second

// Zircon

8001. "zircon_command_line.txt" support.  If file exists in .exe folder it contains command line params like "-game travail +map start -condebug" and if engine is started with no command line parameters, these are used
8002. Zircon console name - including build name
8003. Zircon changes the progress bar color default from blue to gray.
8011. Removed progs/v_nail2.mdl from r_nolerp list to mirror Zircon
8012. Removed deathmatch mini-overlay
8013. **** r_nearest_2d and r_nearest_conchars default 1.  r_nearest_conchars cvar updates texture in real-time.
8081. Demo playback does not capture mouse.
8082. **** scr_loadingscreen_barheight defaults 0 (previous value was 8), added it as a menu setting.
      (The loading bar reduces the immersion into the game for me.  It looks great for Quake 3 style.)
8083. showfps only displays a framerate if fully connected cls.signon == SIGNONS
8084. crosshair color defaults to gray (previously red)
8085. ProQuake looking scr_clock 0/1, shows level time in status bar
8086. showfps never displays in red
8087. Cvars that DarkPlaces Beta prefixed with cl_ while maintaining aliases (showtex, etc.) have had their cl_ form removed to
      reduce cvar and that it seems unlikely there is someone who likes to type more to access a previously existing cvar especially if the alias exists.
      The namespace of cvars beginning with cl_ is already heavily populated.
8088. Removal of cvar aliases to host_timescale (this is the name that Valve Source engine uses and that Quakespasm uses because FitzQuake used it), 
      there is no need for "slowmo" and "timescale" aliases for an uncommonly used cvar that has a standardized name.
8089. sbar_scorerank and sbar_gametime game time removed.
8090. sbar_showprotocol (defaults 1) shows server protocol discretely if +showscores active
8191. Server to client communication of single player skill level (nightmare, easy) in a way that is ignored by DarkPlaces or regular Quake clients.
8192. (When not hosting a game) Frame rate is throttled when not active window, in console or in menu provided.  These "easy to render" situations are not
      an excuse for an engine to start rendering thousands of frames per second, wasting laptop battery or heating gpu and 
      laptops have weak cooling fans and are 90% of personal computers by market share. cl_maxconsole_menu_fps 
8193. con_closeontoggleconsole defaults 2.  This means tilde always closes the console.  (Default, it doesn't close the console if not at the start of an input line)

// DarkPlaces Bug Fixes

9001. viewzoom CL default fix.  Avoids zoom effect on the start of every Quake map by reseting cl viewzoom field.
9002. DarkPlaces Beta gamedir switch crash bug-fix
9003. Clear models/sounds as stale on gamedir change, they aren't valid any more -- avoid errors/issues with wrong content and stale data
9004. Fire Key release on ALT-TAB or minimize (if holding +forward and then ALT-TAB at same time, you will walk forward forever in current dpbeta on Windows)
9005. Quakespasm's Windows DPI awareness trick, fixes menu placement and other 2D elements when Windows scaling is not set to 100% but a higher value like 125% or 150%
9006. Kleskby ALT-TAB fix for certain international keyboards.
9007. Maps of type .obj did not have loadmodel->lit set.  It is true that .obj does not have lighting, but should act as if it does
      so that DarkPlaces dynamic lighting or other methods can light the map.
9011. DarkPlaces Beta was only loading the first q1bsp sky.  Successive map changes, a q1bsp sky was always ignored so as a result E1M1 would have a purple start map sky instead of a blue sky.
9012. More ALT-TAB key release hardening and made in_releaseall clear kbutton structs.
9061. DarkPlaces Beta gamedir switch crash had 2 more factors.  Resolved.  Also rewrote the hash unlink code (although it does not zfree the hash, should it?  DarkPlaces Beta doesn't.)
9062. Clear models/sounds was partially ineffective due to new DarkPlaces Beta different order of events, fixed.
9063. Quake Combat+ map E1M2 bridge, DarkPlaces Beta shows blue light and DarkPlaces classic does not.  The .rtlights file
      has negative rgb values for some colors (3.540270 -0.000000 -2.528764).  Zircon DarkPlaces Beta clamps the RGB values on
      read to a minimum of 0.  However, this cures only the effects of a yet identified difference, the root cause has not
      yet been identified.
9064. Fixed -> Real-time light editor display unaligned and the end of color data spanned beyond the box.

Unfixed or Unverified Bugs ...

9064u. Gamedir change process/vid_restart can lead to a situation where vid_conwidth has a different .integer value than float .value
      Is this due the cvar reset process, is this caused by something I did or something else going on here.  A real next step would
      be to add some _DEBUG checks into the cvar reset process.  I'm not convinced this situation is exclusively related to
      vid_conwidth, I think a special circumstance occurred.

9067u. UNINVESTIGATED SO FAR: I saw Linux print segfault on shutdown.  Does it still happen?  

9068u. NOT FIXED YET.  Largely fixed issues with DarkPlaces Beta having stuck +forward forever on ALT-TAB and other situations.
      However, I have still experienced it once on changelevel.  Eventually I'll find out why.  I have a candidate .. search for
      "9068u"

9069u. NOT FIXED YET.  Quake Combat+ map E1M2 start, the shader for *water1 contains tcMod scale 0.05 0.05 which according to 
       Q3 Shader reference should decrease the size of the texture, making it repeat.  Instead, of shrinking the texture, it
       enlarges it (the opposite).  There are other tcmods in the mix tcMod stretch sin 1 .001 .05 .2 and tcMod scroll 0.016 0.01
       and it is not clear why this occurs and although this is behavior difference between DarkPlaces Beta and DarkPlaces classic,
       it is not known if this is a bug or if DarkPlaces Beta is correctly applying the shader.

       The shader text is:

*water1
	surfaceparm water
	surfaceparm nomarks
	surfaceparm trans
	deformvertexes wave 10 sin 1 1 .1 .6
	{
		blendfunc blend
		tcMod stretch sin 1 .001 .05 .2
		tcMod scale 0.05 0.05
		tcMod scroll 0.016 0.01
		animmap 18 textures/causticBr/FWATER01.png textures/causticBr/FWATER02.png textures/causticBr/FWATER03.png textures/causticBr/FWATER04.png textures/causticBr/FWATER05.png textures/causticBr/FWATER06.png textures/causticBr/FWATER07.png textures/causticBr/FWATER08.png textures/causticBr/FWATER09.png textures/causticBr/FWATER10.png textures/causticBr/FWATER11.png textures/causticBr/FWATER12.png textures/causticBr/FWATER13.png textures/causticBr/FWATER14.png textures/causticBr/FWATER15.png textures/causticBr/FWATER16.png textures/causticBr/FWATER17.png textures/causticBr/FWATER18.png textures/causticBr/FWATER19.png textures/causticBr/FWATER20.png textures/causticBr/FWATER21.png textures/causticBr/FWATER22.png textures/causticBr/FWATER23.png textures/causticBr/FWATER24.png textures/causticBr/FWATER25.png textures/causticBr/FWATER26.png textures/causticBr/FWATER27.png textures/causticBr/FWATER28.png textures/causticBr/FWATER29.png textures/causticBr/FWATER30.png textures/causticBr/FWATER31.png textures/causticBr/FWATER32.png textures/causticBr/FWATER33.png textures/causticBr/FWATER34.png textures/causticBr/FWATER35.png
	}

    Q3 Shader Reference

    tcMod scale <sScale> <tScale>
    Resizes (enlarges or shrinks) the texture coordinates bymultiplying them against the given factors of <sScale> and <tScale).
    The values "s" and "t"conform to the "x" and "y" values (respectively) as they are found in the original texture TGA. 
    The values for sScale and tScale are NOT normalized. This means that a value greater than 1.0 will increase the size of 
    thetexture. A positive value less than one will reduce the texture to a fraction of its size and 
    cause it to repeat within the same area as the original texture (Note: see clampTexCoords for ways to control this).; 


// Other

9501. vid_ignore_taskbar defaults to 1.
      The centering that occurs with taking taskbar into consideration is not center of screen.
      The off-center "center of the screen" window felt weird.

9511. Fixed vid_sdl.h so Windows get a titlebar icon consistently.  Sometimes it was there, sometimes not.




